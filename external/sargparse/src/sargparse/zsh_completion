#/usr/bin/env zsh

if [ ${#} != "1" ] || ! [ -f $1 ]; then
    if ! [ -f "${1}" ]; then
        >&2 echo "'${1}' is not a file"
    fi
    >&2 echo "usage:" ${1}
    >&2 echo "    \$ source ${0} [executable]"
else
	sargparse_GetOpts () {
		PROG="${words[1]}"
		globalParams=$(${PROG} --bash_completion)
		globalCommands=$(echo ${globalParams} | grep "^[^-][^-]")
		globalOptions=$(echo ${globalParams} | grep "^--")

		localParams=$(${PROG} ${(@q)words[@]:1} --bash_completion)
		localCommands=$(echo ${localParams} | grep "^[^-][^-]")
		localOptions=$(echo ${localParams} | grep "^--")
		localSpecialOptions=$(echo ${localParams} | grep "^ -")

		localCommands=$(comm -23  <(echo ${localCommands} |  sort ) <(echo ${globalCommands} | sort))
		localOptions=$(comm -23  <(echo ${localOptions} |  sort ) <(echo ${globalOptions} | sort))

		localCommands=("${(@f)localCommands}")
		localOptions=("${(@f)localOptions}")
		globalCommands=(${(@f)globalCommands})
		globalOptions=(${(@f)globalOptions})

		if [ "${localSpecialOptions}" = " -d " ]; then
			_files -/
		elif [ "${localSpecialOptions}" = " -f " ]; then
			_files
		elif [[ "${localSpecialOptions}" =~ " -f " ]]; then
			EXT="$(echo "${localSpecialOptions}" | cut -d ' ' -f 3)"
			_files -g "*${EXT}"
		else
			compadd -J "G4" -X "%USuggestions%u" -- ${localCommands[@]}
			compadd -J "G3" -X "%ULocal Options%u" -- ${localOptions[@]}
			compadd -J "G1" -X "%UCommands%u" -- ${globalCommands}
			compadd -J "G2" -X "%UGlobal Options%u" -- ${globalOptions[@]}
		fi
	}
	compdef sargparse_GetOpts -P $(basename $1) -N
fi
